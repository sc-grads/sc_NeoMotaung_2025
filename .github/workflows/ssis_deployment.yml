name: Deploy SSIS Package
on: workflow_dispatch

jobs:
  deploy-ssis:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Find .ispac files
      id: find-ispac
      run: |
        $ispac = Get-ChildItem -Path . -Recurse -Filter *.ispac | Select-Object -First 1
        echo "ispac_path=$($ispac.FullName)" >> $env:GITHUB_OUTPUT
        
    
    - name: Deploy SSIS Package
      shell: pwsh
      run: |
        # 1. Store SQL in a file (bypasses command line length limit)
        $sqlFile = "deploy_ssis.sql"
        @"
        BEGIN TRY
            DECLARE @ProjectBinary VARBINARY(MAX) = 0x$([System.BitConverter]::ToString([System.IO.File]::ReadAllBytes("${{ steps.find-ispac.outputs.ispac_path }}")).Replace("-",""))
            DECLARE @OperationId BIGINT
            
            IF NOT EXISTS (SELECT 1 FROM [SSISDB].[catalog].[folders] WHERE name = 'YourFolder')
            BEGIN
                EXEC [SSISDB].[catalog].[create_folder] 
                  @folder_name = 'YourFolder',
                  @folder_id = NULL
            END
            
            EXEC [SSISDB].[catalog].[deploy_project] 
                @folder_name = 'YourFolder',
                @project_name = 'YourProject',
                @Project_Stream = @ProjectBinary,
                @operation_id = @OperationId OUTPUT
                
            SELECT 'Deployment successful' AS Result
        END TRY
        BEGIN CATCH
            SELECT 
                ERROR_NUMBER() AS ErrorNumber,
                ERROR_MESSAGE() AS ErrorMessage
        END CATCH
        "@ | Out-File -FilePath $sqlFile
    
        # 2. Execute with simplified command
        $shortCmd = "sqlcmd -S `"${{ secrets.SQL_SERVER }}`" -U Auto_user -P `"${{ secrets.SQL_PASSWORD }}`" -i `"$sqlFile`""
        Write-Host "Executing: $shortCmd"
        Invoke-Expression $shortCmd
    
        # 3. Verify success
        if ($LASTEXITCODE -ne 0) {
            throw "SSIS deployment failed"
        }
        Write-Host "SSIS package deployed successfully"
