name: Deploy SSIS Package
on: workflow_dispatch

jobs:
  deploy-ssis:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Find .ispac files
      id: find-ispac
      run: |
        $ispac = Get-ChildItem -Path . -Recurse -Filter *.ispac | Select-Object -First 1
        echo "ispac_path=$($ispac.FullName)" >> $env:GITHUB_OUTPUT
        
    - name: Deploy using T-SQL
      shell: pwsh
      run: |
        $ispacBytes = [System.IO.File]::ReadAllBytes("${{ steps.find-ispac.outputs.ispac_path }}")
        $ispacHex = [System.BitConverter]::ToString($ispacBytes).Replace("-","")
        
        $sqlQuery = @"
        DECLARE @ProjectBinary VARBINARY(MAX) = 0x$ispacHex
        DECLARE @OperationId BIGINT
        
        IF NOT EXISTS (SELECT 1 FROM [SSISDB].[catalog].[folders] WHERE name = 'YourFolder')
        BEGIN
            EXEC [SSISDB].[catalog].[create_folder] @folder_name = 'YourFolder'
        END
        
        EXEC [SSISDB].[catalog].[deploy_project] 
            @folder_name = 'YourFolder',
            @project_name = 'YourProject',
            @Project_Stream = @ProjectBinary,
            @operation_id = @OperationId OUTPUT
        "@

        $server = "${{ secrets.SQL_SERVER }}"
        $user = "Auto_user"
        $pass = "${{ secrets.SQL_PASSWORD }}"
        
        sqlcmd -S $server -U $user -P $pass -Q "$sqlQuery"
